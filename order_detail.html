<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>주문 상세 페이지</title>
    <!-- jq  -->
    <script
      src="https://code.jquery.com/jquery-3.6.3.min.js"
      integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <script>
      function create_comment() {
        const search = new URLSearchParams(location.search);
        const order_id = search.get("order_id");
        console.log(order_id);
        $.ajax({
          type: "POST",
          url: "http://127.0.0.1:8000/api/order/comment",
          data: {
            order: order_id,
            content: $("#comment_content").val(),
          },
          beforeSend: function (xhr) {
            xhr.setRequestHeader("Authorization", "JWT " + $("#token").val());
          },
          success: (res) => {
            alert("댓글 추가 완료");
          },
          error: (res) => {
            console.error(res);
          },
        });
      }
      $(document).ready(function () {
        const search = new URLSearchParams(location.search);
        const order_id = search.get("order_id");
        $.get(`http://127.0.0.1:8000/api/order/${order_id}`).then((res) => {
          const temp = [...Object.keys(res)];
          for (let i = 0; i < temp.length; i++) {
            $("#detail").append(
              $(`
              <div id=${temp[i]}>
                  <span> ${temp[i]}</span>
                  <span> : ${res[temp[i]]}</span>
              </div>`)
            );
          }
        });

        $.get(`http://127.0.0.1:8000/api/order/${order_id}/comment`).then(
          (res) => {
            comments = res.results;
            console.log(comments);
            $("#comments").html();
            $("#cmment_count").text(`총 ${comments.length}개의 댓글`);

            for (let i = 0; i < comments.length; i++) {
              const data = comments[i];
              $("#comments").append(
                $(`
              <li class="list-group-item">
                <span id="username">작성자 : ${data.member_username}</span>
                <span id="tstamp">일자 : ${data.tstamp}</span>
                <div id="content">내용 : ${data.content}</div>
              </li>
            `)
              );
            }
          }
        );
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div id="detail"></div>
      <br />
      <div class="mb-3">
        <label for="token" class="form-label">토큰</label>
        <input
          type="text"
          class="form-control"
          id="token"
          placeholder="token"
        />
      </div>
      <div class="mb-3">
        <label for="comment_content" class="form-label">댓글 내용</label>
        <textarea
          class="form-control"
          id="comment_content"
          rows="3"
          placeholder="내용을 입력해주세요"
        ></textarea>
      </div>
      <div class="text-right">
        <button
          onclick="create_comment()"
          type="button"
          class="btn btn-primary"
        >
          댓글 등록
        </button>
      </div>
      <ul class="list-group list-group-flush" id="comments">
        <h3 id="cmment_count"></h3>
      </ul>
    </div>
  </body>
</html>
